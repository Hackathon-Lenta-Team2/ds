# ds
forecast model for Lenta Hackaton
## Структура репозитория

- /scripts - заготовки исполняемых файлов с инференсом модели
  - encoder.pkl, scaler.pkl - энкодер и скейлер для предобработки данных
  - example.csv - кусок submissions.csv, для тестов
  - обученная модель лежит [здесь](https://drive.google.com/file/d/1xw9idnogp-v8FsWYGj8rYGdBWnK3qzwI/view?usp=sharing), чтобы с git lfs не связываться
- /notebooks - воспроизводимый код модели в jupiter и результаты предсказаний для файла sales_submission.csv
_________

## Исследованные гипотезы

В ходе исследования для модели дополнительно гененерировались новые признаки, такие как сдвиг и запаздывающие значения, праздничность или непраздничность дня, время, оставшееся до праздничного дня, номер дня в неделе и в месяце, а также принадлежность товара к тому или иному кластеру.

|**Модель**|**Метрика WAPE на тестовой выборке**|Примечание|
|---|---|---|
|RandomForest|0,45 |  |
|CatBoost Regressor|0,48 |  |
|LinearRegression|0,48 |  |
|LinearRegression с дополнительными признаками, сгенерированными VARMAX|0,48 | Поведение модели менее стабильно. Подробнее результаты исследования приведены [здесь](https://github.com/Hackathon-Lenta-Team2/ds/blob/main/notebooks/drafts/demand_forecast_for_lenta_skus.ipynb)|

Необходимые предсказания были получены, но на данный момент качество модели оставляет желать лучшего, 
необходимы дальнейшие эксперименты по предобработке данных и настройкам обучения моделей.

Также в данный момент пока реализованы предсказания по прочитанной из предварительно собранного .csv файла (имитация обработки запроса на бэкенде).
____

## Предполагаемый сценарий работы с БД

|**Этап**|**Что происходит**|**Где происходит**|
|---|---|---|
|1|запрос: id товара, id магазина, дата = последняя дата архива + 1|backend|
|2|из базы данных товаров загружаются значения полей ('pr_group_id',	'pr_cat_id', 'pr_subcat_id', 'pr_uom_id'), из базы данных магазинов - ('st_city_id', 'st_division_code','st_type_format_id', 'st_type_loc_id', 'st_type_size_id')|backend|
|3|из архива продаж загружаются данные по продажам этой пары "товар-магазин" за предыдущие дни с -21-го по -14-й ('lag_14','lag_15', 'lag_16', 'lag_17', 'lag_18', 'lag_19', 'lag_20', 'lag_21'), при этом сдвигаясь для разных дат прогноза. Так, для прогноза на завтра - lag_14 = 2 недели назад, а для прогноза на через 2 недели - lag_14 = вчера|backend|
|4|данные указанные выше объединяются и в формате (в каком? идеально было бы в .csv длиной в 14 строк по числу дней прогноза) передаются на вход ml|backend|
|5|Рассчитывается скользящее среднее ('rolling_mean')|ML|
|6|дата преобразуется в номер дня недели, дня в месяце, привязка к выходным и праздникам ('holiday', 'day_of_week', 'day_of_month', 'is_weekend')|ML|
|7|на основании сохраненной матицы корреляции расчитывается кластер товара ('cluster')|ML|
|8|данные кодируются, масштабируются и передаются в модель для предсказаний|ML|
|9|предсказанные значения сохраняются в словарь и записываются в json файл|ML|

