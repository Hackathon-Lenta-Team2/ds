# Прогноз спроса товаров сети гипермаркетов "Лента"

## Структура репозитория

- /scripts - заготовки исполняемых файлов с инференсом модели
  - encoder.pkl, scaler.pkl - энкодер и скейлер для предобработки данных
  - example.csv - часть submissions.csv для тестов
  - обученная модель лежит [здесь](https://drive.google.com/file/d/1_hg6Ik4bL5PoKDJzi39wJ1R5K67L0H8K/view?usp=sharing)
- /notebooks - воспроизводимый код модели в jupiter и результаты предсказаний для файла sales_submission.csv
_________

## Запуск модели

- склонировать ds репозиторий
```bash
  git clone git@github.com:Hackathon-Lenta-Team2/ds.git
```
- модель находится в папке /scripts
- в папку scripts/scr нужно скачать модель по [ссылке](https://drive.google.com/file/d/1_hg6Ik4bL5PoKDJzi39wJ1R5K67L0H8K/view?usp=sharing)
- данные для прогноза должны лежать в scripts/src/tmp/ds_data.csv
- сборка образа в папке scripts/
  ```bash
  docker build --tag ds_lenta .
  ```
- запуск контейнера
   ```bash
  docker run --rm -it -p 8001:8000 --name ds ds_lenta
  ```
- после этого модель работает по адресу ```http://localhost:8001/ds/start```
- выводится статус, что выполняется прогноз, в это время в фоновом режиме выполняется функция make_forecast() из app.py
- по окончании прогноза результат сохраняется в scripts/scr/tmp/forecast_archive.json
- отправляется get-запрос по адресу ```http://localhost/api/v1/import-data/```
____________________

## Исследованные гипотезы

В ходе исследования для модели дополнительно генерировались новые признаки, такие как запаздывающие значения и скользящее среднее, флаг праздника даты, учитывающий и несколько дней до него, номер дня в неделе и в месяце, а также принадлежность товара к тому или иному кластеру.

|**Модель**|**Метрика WAPE на тестовой выборке**|Примечание|
|---|---|---|
|RandomForest|0,45 |  |
|CatBoost Regressor|0,48 |  |
|LinearRegression|0,48 |  |
|LinearRegression с дополнительными признаками, сгенерированными VARMAX|0,48 | Поведение модели менее стабильно. Подробнее результаты исследования приведены [здесь](https://github.com/Hackathon-Lenta-Team2/ds/blob/main/notebooks/drafts/demand_forecast_for_lenta_skus.ipynb)|

Необходимые предсказания были получены, но на данный момент качество модели оставляет желать лучшего, 
необходимы дальнейшие эксперименты по предобработке данных и настройкам обучения моделей.

Также в данный момент пока реализованы предсказания по информации, прочитанной из предварительно собранного csv-файла (имитация обработки запроса на бэкенде).
____

## Предполагаемый сценарий работы с БД

|**Этап**|**Что происходит**|**Где происходит**|
|---|---|---|
|1|запрос: id товара, id магазина|backend|
|2|из базы данных товаров загружаются значения полей ('pr_group_id',	'pr_cat_id', 'pr_subcat_id', 'pr_uom_id'), из базы данных магазинов - ('st_city_id', 'st_division_code','st_type_format_id', 'st_type_loc_id', 'st_type_size_id')|backend|
|3|из архива продаж загружаются данные по продажам этой пары "товар-магазин" за предыдущие дни с 0-го по 21-й |backend|
|4|данные, указанные выше, объединяются в файл csv с количеством строк равным количеству запросов и передаются на вход ml|backend|
|5|на основани  с таблицей по продажам рассчитываются лаги ('lag_14','lag_15', 'lag_16', 'lag_17', 'lag_18', 'lag_19', 'lag_20', 'lag_21'), при этом сдвигаясь для разных дат прогноза. Так, для прогноза на завтра - lag_14 = 2 недели назад, а для прогноза на дату через 2 недели - lag_14 = вчера. рассчитывается скользящее среднее ('rolling_mean')|ML|
|6|дата преобразуется в номер дня недели, дня в месяце, выполняется привязка к выходным и праздникам ('holiday', 'day_of_week', 'day_of_month', 'is_weekend')|ML|
|7|данные кодируются, масштабируются и передаются в модель для предсказаний|ML|
|8|предсказанные значения сохраняются в словарь и записываются в json-файл|ML|

